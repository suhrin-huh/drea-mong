# í¬íŒ… ë§¤ë‰´ì–¼

# ì‚¬ìš© í”„ë¡œê·¸ë¨ ë²„ì „

---

<aside>
ğŸ’¡ **í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•œ í”„ë¡œê·¸ë¨ì˜ ë²„ì „ì„ ì •ë¦¬í•©ë‹ˆë‹¤.**

</aside>

## Backend

- Development Tool
    - JDK : 17.0.11
    - gradle : 8.8
- Framework
    - Spring boot : 3.3.2
        - Spring data JPA
        - Validation
    - Spring Doc: 2.0.2
    - OpenAI: 1.0.0-M1
    - Spring Cloud AWS: 2.2.6.RELEASE
- Security
    - JWT 0.12.3
    - Spring Security
    - OAuth2 Client
- Database
    - MySQL: 8.0.36
    - Spring Data Redis: 3.3.2
- Networking and Sockets
    - Netty-SocketIO: 2.0.11
- Utilities
    - Lombok: 1.18.34
    - OkHttp: 4.9.3
- Infra
    - Ununtu: 20.04.6 LTS
    - Docker: 27.1.1
    - Docker Compose : 2.29.1
    - Nginx: 1.27.0
    - certbot: 0.40.0
    - MySQL: 9.0.1

---

## Frontend

---

- **axios**: 1.7.2
- **flowbite-react**: 0.10.1
- **ldrs**: 1.0.2
- **react**: 18.3.1
- **react-dom**: 18.3.1
- **react-infinite-scroll-component**: 6.1.0
- **react-modal**: 3.16.1
- **react-router-dom**: 6.25.1
- **react-speech-recognition**: 3.10.0
- **react-youtube**: 10.1.0
- **recoil**: 0.7.7
- **regenerator-runtime**: 0.14.1
- **socket.io-client**: 4.7.5
- **sweetalert2**: 11.6.13
- **swiper**: 11.1.9

# ë°°í¬í™˜ê²½

---

<aside>
ğŸ’¡ **ì„œë²„êµ¬ì„±ì— ì‚¬ìš©ëœ ì½”ë“œë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤**

</aside>

Front

1. nvm ì„¤ì¹˜
    
    ```bash
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
    source ~/.bashrc
    ```
    
2. Node.js 20.15 ë²„ì „ ì„¤ì¹˜ ë° ì‚¬ìš©
    
    ```bash
    nvm install 20.15.0
    nvm use 20.15.0
    
    npm install -g npm@latest
    ```
    
3. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
    
    ```bash
    cd ~/project/S11P12C106/frontend/dreamong
    npm install
    npm run build
    ```
    

Docker Compose

```bash
sudo apt install docker-compose
```

ec2 ì •ë³´ ì¡°íšŒ :Â `cat /etc/**release**`

## ì„œë¹„ìŠ¤ í¬íŠ¸ ë¬¸ì„œí™”

### SSH

- **í¬íŠ¸ ë²ˆí˜¸:** 22
- **ì—­í• :** ì›ê²© ì„œë²„ ê´€ë¦¬ ë° ì ‘ê·¼

### MySQL (mysql-container)

- **í¬íŠ¸ ë²ˆí˜¸:** 3306
- **ì—­í• :** MySQL Database Server

### Redis (redis-container)

- **í¬íŠ¸ ë²ˆí˜¸:** 6379
- **ì—­í• :** Redis Database Server

### Backend (backend-container)

- **í¬íŠ¸ ë²ˆí˜¸:** 8080
- **ì—­í• :** Spring Boot Server
- **í¬íŠ¸ ë²ˆí˜¸:** 9093
- **ì—­í• : N**etty Socket Server

### Frontend (frontend-container)

- **í¬íŠ¸ ë²ˆí˜¸:** 5173
- **ì—­í• :**  React Front Application

### Nginx (nginx-container)

- **í¬íŠ¸ ë²ˆí˜¸:** 80, 443
- **ì—­í• :** HTTP, HTTPS Web Server (Reverse Proxy)

## /etc/nginx/nginx.conf

```bash
user www-data;
worker_processes auto;
pid /run/nginx.pid;
#include /etc/nginx/modules-enabled/*.conf;

events {
        worker_connections 768;
        # multi_accept on;
}

http {

        ##
        # Basic Settings
        ##

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        # server_tokens off;

        # server_names_hash_bucket_size 64;
        # server_name_in_redirect off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        ##
        # SSL Settings
        ##

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;

        ##
        # Logging Settings
        ##

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        ##
        # Gzip Settings
        ##

        gzip on;

        # gzip_vary on;
        # gzip_proxied any;
        # gzip_comp_level 6;
        # gzip_buffers 16 8k;
        # gzip_http_version 1.1;
        # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        ##
        # Virtual Host Configs
        ##
        include /etc/nginx/sites-available/*;
        include /etc/nginx/conf.d/*.conf;
        #include /etc/nginx/sites-enabled/*;
}

#mail {
#       # See sample authentication script at:
#       # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
#
#       # auth_http localhost/auth.php;
#       # pop3_capabilities "TOP" "USER";
#       # imap_capabilities "IMAP4rev1" "UIDPLUS";
#
#       server {
#               listen     localhost:110;
#               protocol   pop3;
#               proxy      on;
#       }
#
#       server {  
#               protocol   imap;
#               proxy      on;
#       }
#}
           
```

## /etc/nginx/sites-available/default

```bash
resolver 127.0.0.11 valid=30s;

# HTTP ìš”ì²­ì„ HTTPSë¡œ ë¦¬ë””ë ‰ì…˜í•˜ëŠ” ì„œë²„ ë¸”ë¡
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name i11c106.p.ssafy.io;

    # ëª¨ë“  HTTP ìš”ì²­ì„ HTTPSë¡œ ë¦¬ë””ë ‰ì…˜
    return 301 https://$host$request_uri;
}

# SSLì„ ì‚¬ìš©í•œ HTTPS ì„œë²„ ë¸”ë¡
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name i11c106.p.ssafy.io;

    # SSL ì¸ì¦ì„œ ê²½ë¡œ ë° í‚¤
    ssl_certificate /etc/letsencrypt/live/i11c106.p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/i11c106.p.ssafy.io/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location = /firebase-messaging-sw.js {
        root /app/dist;  # ë¹Œë“œëœ ì •ì  íŒŒì¼ì´ ìœ„ì¹˜í•œ ê²½ë¡œ
        default_type application/javascript;
        types { }
        add_header Service-Worker-Allowed "/";
        add_header Cache-Control "no-cache";
#       try_files $uri =404;
    }

    # ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡ì‹œ ì„¤ì •
    location /api {
        proxy_pass http://backend-container:8080;
#        proxy_pass http://172.18.0.4:8080;  # ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ ì¤‘ì¸ í¬íŠ¸
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_buffer_size          128k;
        proxy_buffers              4 256k;
        proxy_busy_buffers_size    256k;
    }

    # í”„ë¡ íŠ¸ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡ì‹œ ì„¤ì •
    location / {
        proxy_pass http://frontend-container:5173;
#        proxy_pass http://172.18.0.3:5173;  # í”„ë¡ íŠ¸ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ ì¤‘ì¸ í¬íŠ¸
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
#       try_files $uri $uri/ /index.html;  # í”„ë¡ íŠ¸ì—”ë“œ SPA ì§€ì›

        proxy_buffer_size          128k;
        proxy_buffers              4 256k;
        proxy_busy_buffers_size    256k;

    }

    # WebSocket í”„ë¡ì‹œ ì„¤ì •
    location /socket.io/ {
        proxy_pass http://172.18.0.4:9093;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocketì— ëŒ€í•œ ë²„í¼ ì„¤ì •
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        
        # WebSocket ì—°ê²° ì‹œ timeout ì„¤ì •
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        proxy_connect_timeout 60s;

        # WebSocket íŠ¹í™” ì„¤ì • ì¶”ê°€
        proxy_buffering off;  # WebSocket ì—°ê²°ì‹œ ë²„í¼ ì¢…ë£Œ
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Ssl on;
     }

    # ì¶”ê°€ ë³´ì•ˆ í—¤ë”
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
}
           
```

## YML ì„¤ì •íŒŒì¼

- application.yml

```bash
spring:
  application:
    name: dreamong

  sql:
    init:
      mode: always
      continue-on-error: true

  jpa:
    hibernate:
      ddl-auto: none
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
    properties:
      hibernate:
        format_sql: true
      default_batch_fetch_size: 100
      open-in-view: false

  jwt:
    secret: 
    access-token-expiration: 3600000 # 1ì‹œê°„(ms)
    refresh-token-expiration: 604800000  # 7ì¼(ms)
  ai:
    openai:
      api-key: 
      chat:
        options:
          model: gpt-4o-mini

cloud:
  aws:
    s3:
      bucket: dreamongbucket
    credentials:
      access-key: 
      secret-key: 
    region:
      static: ap-northeast-2
      auto: false
    stack:
      auto: false

novita:
  api:
    key: 

clova:
  api:
    url: https://clovagreeneye.apigw.ntruss.com/custom/v1/128/c9eee8f785a02fef9693128952bf62e292001c1cc5404e04667bc0c93e5e2fc6/predict
    secret: 

deepl:
  api:
    url: "https://api-free.deepl.com/v2/translate"
    key: 

logging.level:
  org.hibernate.SQL: debug
  org.springframework.web: debug
```

- application-local.yml

```bash
socketio:
  server:
    hostname: localhost
    port: 9093

login:
  callback-url: http://localhost:5173/callback

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/dreamong?useSSL=false&useUnicode=true&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
    username: 
    password: 
    driver-class-name: com.mysql.cj.jdbc.Driver

  data:
    redis:
      host: localhost
      port: 6379
      repositories:
        enabled: false

  security:
    oauth2:
      client:
        registration:
          naver:
            scope: name,email
            client-name: naver
            client-id: 
            redirect-uri: http://localhost:8080/login/oauth2/code/naver
            authorization-grant-type: authorization_code
            client-secret: 
          google:
            authorization-grant-type: authorization_code
            redirect-uri: http://localhost:8080/login/oauth2/code/google
            client-name: google
            client-id: 
            client-secret: 
            scope: profile,email
          kakao:
            redirect-uri: http://localhost:8080/login/oauth2/code/kakao
            authorization-grant-type: authorization_code
            client-id: 
            #client-secret: 
            scope: profile_nickname,account_email
            client-name: kakao

        provider:
          kakao:
            user-name-attribute: id
            user-info-uri: https://kapi.kakao.com/v2/user/me
            authorization-uri: https://kauth.kakao.com/oauth/authorize
            token-uri: https://kauth.kakao.com/oauth/token
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-name-attribute: response
            token-uri: https://nid.naver.com/oauth2.0/token

```

- application-prod.yml

```bash
server:
  servlet:
    context-path: /api

socketio:
  server:
    hostname: 0.0.0.0
    port: 9093

login:
  callback-url: https://i11c106.p.ssafy.io/callback

spring:
  datasource:
    url: jdbc:mysql://mysql-container:3306/dreamong?useSSL=false&useUnicode=true&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
    username: 
    password: 
    driver-class-name: com.mysql.cj.jdbc.Driver

  data:
    redis:
      host: redis-container
      port: 6379
      repositories:
        enabled: false

  security:
    oauth2:
      client:
        registration:
          naver:
            scope: name,email
            client-name: naver
            client-id: xH48M2F3uLnkCwZoejKy
            redirect-uri: https://i11c106.p.ssafy.io/api/login/oauth2/code/naver
            authorization-grant-type: authorization_code
            client-secret: 
          google:
            authorization-grant-type: authorization_code
            redirect-uri: https://i11c106.p.ssafy.io/api/login/oauth2/code/google
            client-name: google
            client-id: 
            client-secret: 
            scope: profile,email
          kakao:
            redirect-uri: https://i11c106.p.ssafy.io/api/login/oauth2/code/kakao
            authorization-grant-type: authorization_code
            client-id: 
            #client-secret: 
            scope: profile_nickname,account_email
            client-name: kakao

        provider:
          kakao:
            user-name-attribute: id
            user-info-uri: https://kapi.kakao.com/v2/user/me
            authorization-uri: https://kauth.kakao.com/oauth/authorize
            token-uri: https://kauth.kakao.com/oauth/token
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-name-attribute: response
            token-uri: https://nid.naver.com/oauth2.0/token

```

- .env

```bash
MYSQL_ROOT_PASSWORD=
MYSQL_DATABASE=
MYSQL_USER=
MYSQL_PASSWORD=
```

- Dokcerfile - BE

```bash
# ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì„ íƒ
FROM openjdk:17-jdk-slim

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì†ŒìŠ¤ì½”ë“œ ë³µì‚¬
COPY . .

# ë¹Œë“œ ì‹¤í–‰
RUN ./gradlew clean build

# ë¹Œë“œëœ JAR íŒŒì¼ ë³µì‚¬
ARG JAR_FILE=build/libs/*.jar
COPY ${JAR_FILE} app.jar

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV SPRING_PROFILES_ACTIVE=prod

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
ENTRYPOINT ["java", "-jar", "app.jar"]
```

- Dockerfile - FE

```bash
## Node.js 20.15 ì´ë¯¸ì§€ ì‚¬ìš©
#FROM node:20.15-alpine AS build
#
## ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
#WORKDIR /app
#
## package.jsonê³¼ package-lock.jsonì„ ë³µì‚¬í•˜ê³  npm ì„¤ì¹˜
#COPY package*.json ./
#RUN npm install
#
## ë‚˜ë¨¸ì§€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤ ë³µì‚¬
#COPY . .
#
## ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
#RUN npm run build
#
## Nginxë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì  íŒŒì¼ ì œê³µ
#FROM nginx:alpine
#
## ë¹Œë“œëœ íŒŒì¼ì„ Nginx ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
#COPY --from=build /app/dist /usr/share/nginx/html
#
## Nginx ì„¤ì • íŒŒì¼ ë³µì‚¬
#COPY nginx.conf /etc/nginx/conf.d/default.conf
#
## Nginx ì‹¤í–‰
#CMD ["nginx", "-g", "daemon off;"]

# 1ë‹¨ê³„: React ì•± ë¹Œë“œ
FROM node:20.15-alpine AS build

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# package.json ë° package-lock.json íŒŒì¼ ë³µì‚¬
COPY package*.json ./

# ì¢…ì†ì„± ì„¤ì¹˜
RUN npm install

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# React ì•± ë¹Œë“œ
RUN npm run build

# dist ë””ë ‰í† ë¦¬ì˜ ë‚´ìš© í™•ì¸
RUN ls -la /app/dist

# Stage 2: Node.js ì„œë²„ë¡œ React ì•± ì œê³µ
FROM node:20.15-alpine

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# serve íŒ¨í‚¤ì§€ ì „ì—­ ì„¤ì¹˜
RUN npm install -g serve

# ì´ì „ ë‹¨ê³„ì—ì„œ ë¹Œë“œëœ ì¶œë ¥ë¬¼ ë³µì‚¬
COPY --from=build /app/dist /app/dist

# í¬íŠ¸ 5173 ë…¸ì¶œ
EXPOSE 5173

# ì„œë²„ ì‹œì‘
CMD ["serve", "-s", "dist", "-l", "5173"]
```

docer-compose.yml

```bash
services:
  mysql:
    image: mysql:latest
    container_name: mysql-container
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - dreamong-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 30s
      timeout: 10s
      retries: 5

  redis:
    image: redis:latest
    container_name: redis-container
    ports:
      - "6379:6379"
    networks:
      - dreamong-network
    volumes:
      - redis-data:/data
    restart: always

  backend:
    build:
      context: ./backend/dreamong
    container_name: backend-container
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-container:3306/${MYSQL_DATABASE}?useSSL=false&useUnicode=true&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
    depends_on:
      - mysql
      - redis
    ports:
      - "8080:8080"
      - "9093:9093"
    networks:
      - dreamong-network
    restart: on-failure

  frontend:
    build:
      context: ./frontend/dreamong
    container_name: frontend-container
    volumes:
      - frontend-dist:/app/dist  # dist ë””ë ‰í† ë¦¬ë¥¼ ê³µìœ 
    ports:
      - "5173:80"
    networks:
      - dreamong-network

  nginx:
    image: nginx:latest
    container_name: nginx-container
    depends_on:
      - backend
      - frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/nginx/nginx.conf:/etc/nginx/nginx.conf
      - /etc/nginx/sites-available:/etc/nginx/sites-available
      - /etc/nginx/sites-enabled:/etc/nginx/sites-enabled
      - /etc/letsencrypt:/etc/letsencrypt
      - frontend-dist:/app/dist  # Nginxì— dist ë””ë ‰í† ë¦¬ë¥¼ ë§ˆìš´íŠ¸
    networks:
      - dreamong-network
    restart: always

volumes:
  mysql-data:
  redis-data:
  frontend-dist:  # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ì„ ì €ì¥í•  ë³¼ë¥¨

networks:
  dreamong-network:
```

## ì„œë²„í™˜ê²½ ì„¤ì •

### ì„œë²„ ë°©í™”ë²½ ì„¤ì •

```bash
# ufw ì„¤ì¹˜ëª…ë ¹
sudo apt-get install ufw

# ufw ìƒíƒœí™•ì¸ ëª…ë ¹
sudo ufw status verbose
sudo ufw status

sudo ufw allow 22 # ssh (ì´ê±°í•˜ê³  í™œì„±í™”í•´ì•¼í•¨!)
sudo ufw enable 

# ...
sudo ufw status
```